name: Superuser CI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
    
    - name: Run Tests
      run: |
        # Compile test
        cd ${{ github.workspace }}/Superuser_main
        ${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang su.c -o su-armv7
        
        # Basic compilation checks
        if [ ! -f "su-armv7" ]; then
          echo "Compilation failed"
          exit 1
        fi
        
        # File permission checks
        if [ "$(stat -c %a su-armv7)" != "755" ]; then
          echo "Incorrect file permissions"
          exit 1
        fi

    - name: Run Enhanced Tests
      run: |
        # Test script for enhanced checks
        cd ${{ github.workspace }}/Superuser_main
        # Test: Compilation
        ${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang su.c -o su-armv7
        if [ ! -f "su-armv7" ]; then
          echo "Compilation failed"; exit 1
        fi
        # Test: Permissions (should be 6755 for su)
        chmod 6755 su-armv7
        chown root:root su-armv7 || true
        if [ "$(stat -c %a su-armv7)" != "6755" ]; then
          echo "Incorrect file permissions (expected 6755)"; exit 1
        fi
        # Test: Paths
        su_paths=(
          "/system/bin/su" "/system/xbin/su" "/sbin/su" "/su/bin/su" "/su/xbin/su" "/system/sbin/su" "/magisk/.core/bin/su" "/debug_ramdisk/su" "/sbin/bin/su" "/system/su" "/system/xbin/daemonsu" "/system/xbin/busybox" "/su" "/xbin/su" "/bin/su" "/0/su"
        )
        for path in "${su_paths[@]}"; do
          dir=$(dirname "$path")
          if [ ! -d "$dir" ]; then
            echo "Directory $dir does not exist"; exit 1
          fi
        done
        # Test: AI-driven compatibility (simulate)
        echo "Device Architecture: armeabi-v7a"
        echo "Android Version: 10"
        echo "SDK Version: 29"
        # Test: Error handling (simulate)
        false || echo "Simulated error handling works"
        echo "All enhanced tests passed."